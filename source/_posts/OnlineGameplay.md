# Gameplay同步

GamePlay常见的的分类方式是分为主动技能，被动技能，Buff三个部分。

## 主动技能

主动技能会包含一些游戏逻辑，譬如造成伤害，播放动画，添加Buff...这些逻辑在游戏世界中通常需要一个逻辑承载体，在项目中这个承载体是AGE Action， Unreal的Gameplay Ability System框架下这个承载体是Gameplay Ability。通常来说程序在承载体中实现Gameplay的原子（接口），策划使用这些接口来实现最终的主动技能效果。

如果是单机模式，释放一个主动技能只需要将这个逻辑承载体创建在场景中并执行。

联机模式下，主动技能一般有两种处理模式：

### 预表现

技能的预表现与移动的预表现逻辑类似，先在本地客户端执行技能逻辑，再把释放技能的指令发送到权威服务器进行校验。


- 如果校验成功可以释放技能，那么就在服务器上执行技能逻辑，并用RPC通知其他客户端该角色释放了技能，在其他的客户端上也执行技能逻辑。

![](OnlineGameplay/Presimulate.png)  

- 如果校验失败，那么权威服务器和其他客户端都不会执行技能逻辑，权威服务器还会通知本地客户端校验失败，回滚本地执行的逻辑。

![](OnlineGameplay/SimulateFailRollBack.png)

因为有预表现，玩家输入指令后本地客户端的角色能够立刻做出反应，手感是较为优秀的，但是问题在于可能会有客户端和服务器的逻辑不一致。

![](OnlineGameplay/SimulateConflict.png)
<center>图中对时间轴进行了拉伸</center>

设想这样一种情况，某个时刻玩家释放主动技能，这个主动技能的效果是立刻发射出一颗带轨迹的子弹，但在这个时刻，服务器认为该角色已经被其他玩家冰冻了，不应该释放技能。如果不做任何处理，权威服务器会命令本地客户端回滚技能效果。

从主动技能释放，到最终被服务器的RPC纠正回滚，至少会有一个RTT的延时，如果在这段时间内这个子弹命中了敌人，就会有本地客户端观察到子弹命中了，但却没有照成伤害。

### 动作前摇



## 被动技能



## Buff
